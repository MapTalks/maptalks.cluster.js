/*!
 * maptalks.markercluster v0.7.0
 * LICENSE : MIT
 * (c) 2016-2017 maptalks.org
 */
/*!
 * requires maptalks@>=0.26.3 
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("maptalks")):"function"==typeof define&&define.amd?define(["exports","maptalks"],e):e(t.maptalks=t.maptalks||{},t.maptalks)}(this,function(t,e){"use strict";function r(t,e){for(var r=Object.getOwnPropertyNames(e),o=0;o<r.length;o++){var i=r[o],n=Object.getOwnPropertyDescriptor(e,i);n&&n.configurable&&void 0===t[i]&&Object.defineProperty(t,i,n)}return t}function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function n(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):r(t,e))}var a=function(t){function r(){return o(this,r),i(this,t.apply(this,arguments))}return n(r,t),r.fromJSON=function(t){if(!t||"ClusterLayer"!==t.type)return null;for(var o=new r(t.id,t.options),i=t.geometries,n=[],a=0;a<i.length;a++){var s=e.Geometry.fromJSON(i[a]);s&&n.push(s)}return o.addGeometry(n),o},r.prototype.addMarker=function(t){return this.addGeometry(t)},r.prototype.addGeometry=function(r){for(var o=0,i=r.length;o<=i;o++)if(!r[o]instanceof e.Marker)throw new Error("Only a point(Marker) can be added into a ClusterLayer");return t.prototype.addGeometry.apply(this,arguments)},r.prototype.onConfig=function(e){if(t.prototype.onConfig.call(this,e),e.maxClusterRadius||e.symbol||e.drawClusterText||e.textSymbol||e.maxClusterZoom){var r=this._getRenderer();r&&r.render()}return this},r.prototype.identify=function(e,r){var o=this.getMap(),i=this.options.maxClusterZoom;return i&&o&&o.getZoom()>i?t.prototype.identify.call(this,e,r):this._getRenderer()?this._getRenderer().identify(e,r):null},r.prototype.toJSON=function(){var e=t.prototype.toJSON.call(this);return e.type="ClusterLayer",e},r.prototype.getClusters=function(){var t=this._getRenderer();return t?t._currentClusters||[]:[]},r}(e.VectorLayer);a.mergeOptions({maxClusterRadius:160,symbol:null,drawClusterText:!0,textSymbol:null,animation:!0,animationDuration:450,maxClusterZoom:null,noClusterWithOneMarker:!0,forceRenderOnZooming:!0,interact:!0}),a.registerJSONType("ClusterLayer");var s={textFaceName:'"microsoft yahei"',textSize:16,textDx:0,textDy:0},l={markerType:"ellipse",markerFill:{property:"count",type:"interval",stops:[[0,"rgb(135, 196, 240)"],[9,"#1bbc9b"],[99,"rgb(216, 115, 149)"]]},markerFillOpacity:.7,markerLineOpacity:1,markerLineWidth:3,markerLineColor:"#fff",markerWidth:{property:"count",type:"interval",stops:[[0,40],[9,60],[99,80]]},markerHeight:{property:"count",type:"interval",stops:[[0,40],[9,60],[99,80]]}};a.registerRenderer("canvas",function(t){function r(n){o(this,r);var a=i(this,t.call(this,n));if(a._animated=!0,a._refreshStyle(),a._clusterNeedRedraw=!0,a.layer.options.interact){var s=a.layer.getMap(),l=e.INTERNAL_LAYER_PREFIX+"_markercluster_spreadoutLayer";a._spreadoutLayer=a._spreadoutLayer?a._spreadoutLayer:new e.VectorLayer(l).addTo(s),s.on("click",function(t){for(var e=this.identify(t.coordinate),r=e.center,o=e.children.length,i=0;i<o;i++){var n=this._calculateTo(r,i,o);this._createline(r,n,e.children[i])}},a),s.on("zoomend",function(){this._spreadoutLayer&&this._spreadoutLayer.clear()},a)}return a}return n(r,t),r.prototype.checkResources=function(){var r=this.layer.options.symbol||l,o=t.prototype.checkResources.apply(this,arguments);if(r!==this._symbolResourceChecked){var i=e.Util.getExternalResources(r,!0);i&&o.push.apply(o,i),this._symbolResourceChecked=r}return o},r.prototype.draw=function(){this.canvas||this.prepareCanvas();var e=this.getMap().getZoom(),r=this.layer.options.maxClusterZoom;if(r&&e>r)return delete this._currentClusters,this._markersToDraw=this.layer._geoList,void t.prototype.draw.apply(this,arguments);this._clusterNeedRedraw&&(this._clearDataCache(),this._computeGrid(),this._clusterNeedRedraw=!1);var o=this._clusterCache[e]?this._clusterCache[e].clusters:null,i=this._getClustersToDraw(o);i.zoom=e,this._drawLayer(i)},r.prototype._getClustersToDraw=function(t){this._markersToDraw=[];var r=this.getMap(),o=e.StringUtil.getFont(this._textSymbol),i=e.StringUtil.stringLength("9",o).toPoint(),n=r.getContainerExtent(),a=[],s=void 0,l=void 0,u=void 0,p=void 0,h=void 0;for(var c in t)if(this._currentGrid=t[c],1===t[c].count&&this.layer.options.noClusterWithOneMarker){var y=t[c].children[0];y._cluster=t[c],this._markersToDraw.push(y)}else p=(u=this._getSprite()).canvas.width,h=u.canvas.height,s=r._prjToContainerPoint(t[c].center),l=new e.PointExtent(s.sub(p,h),s.add(p,h)),n.intersects(l)&&(t[c].textSize||(t[c].textSize=new e.Point(i.x*(t[c].count+"").length,i.y)._multi(.5)),a.push(t[c]));return a},r.prototype.drawOnInteracting=function(){this._currentClusters&&this._drawClusters(this._currentClusters,1),t.prototype.drawOnInteracting.apply(this,arguments)},r.prototype.forEachGeo=function(t,e){this._markersToDraw&&this._markersToDraw.forEach(function(r){e?t.call(e,r):t(r)})},r.prototype.onGeometryAdd=function(){this._clusterNeedRedraw=!0,t.prototype.onGeometryAdd.apply(this,arguments)},r.prototype.onGeometryRemove=function(){this._clusterNeedRedraw=!0,t.prototype.onGeometryRemove.apply(this,arguments)},r.prototype.onGeometryPositionChange=function(){this._clusterNeedRedraw=!0,t.prototype.onGeometryPositionChange.apply(this,arguments)},r.prototype.onRemove=function(){this._clearDataCache()},r.prototype.identify=function(e,r){var o=this.getMap(),i=this.layer.options.maxClusterZoom;if(i&&o.getZoom()>i)return t.prototype.identify.call(this,e,r);if(this._currentClusters){for(var n=o.coordinateToContainerPoint(e),a=this._currentGrid,s=0;s<this._currentClusters.length;s++){var l=this._currentClusters[s],u=o._prjToContainerPoint(l.center);this._currentGrid=l;var p=this._getSprite().canvas.width;if(n.distanceTo(u)<=p)return{center:o.getProjection().unproject(l.center.copy()),children:l.children.slice(0)}}this._currentGrid=a}return this._markersToDraw?this.layer._hitGeos(this._markersToDraw,e,r):null},r.prototype.onSymbolChanged=function(){this._refreshStyle(),this._computeGrid(),this._stopAnim(),this.setToRedraw()},r.prototype._refreshStyle=function(){var t=this,r=this.layer.options.symbol||l,o=this.layer.options.textSymbol||s,i=function(){return[t.getMap().getZoom(),t._currentGrid]};this._symbol=e.MapboxUtil.loadFunctionTypes(r,i),this._textSymbol=e.MapboxUtil.loadFunctionTypes(o,i)},r.prototype._drawLayer=function(t){var r=this,o=this._currentClusters;this._currentClusters=t,delete this._clusterMaskExtent;var i=this.layer;if(i.options.animation&&this._animated&&this._inout){var n=[0,1];"in"===this._inout&&(n=[1,0]),this._player=e.animation.Animation.animate({d:n},{speed:i.options.animationDuration,easing:"inAndOut"},function(e){"finished"===e.state.playState?(r._animated=!1,r._drawClusters(t,1),r._drawMarkers(),r.completeRender()):("in"===r._inout?r._drawClustersFrame(t,o,e.styles.d):r._drawClustersFrame(o,t,e.styles.d),r.setCanvasUpdated())}).play()}else this._animated=!1,this._drawClusters(t,1),this._drawMarkers(),this.completeRender()},r.prototype._drawMarkers=function(){t.prototype.drawGeos.call(this,this._clusterMaskExtent)},r.prototype._calculateTo=function(t,r,o){var i=this.layer.getMap(),n=60,a=0;o<=10?(n=60,a=360/o*2*r):(n=60+5*r,a=64*r);var s=i.coordinateToContainerPoint(t),l=s.x+n*Math.cos(a*Math.PI/360),u=s.y-n*Math.sin(a*Math.PI/360);return i.containerPointToCoordinate(new e.Point(l,u))},r.prototype._createline=function(t,r,o){var i=null,n=this.layer.options.markerFile,a=this._spreadoutLayer;new e.LineString([t,r],{symbol:[{lineWidth:1,lineColor:"rgba(36,138,74,1)",lineCap:"round"}]}).addTo(a).animateShow({duration:500,easing:"out"},function(t,r){i=i?i.setCoordinates(r):new e.Marker(r,{symbol:{markerFile:n},properties:o.getProperties()}).addTo(a)}).play()},r.prototype._drawClustersFrame=function(t,e,r){var o=this;this._clusterMaskExtent=this.prepareCanvas();var i=this.getMap(),n={};if(t&&t.forEach(function(t){var e=i._prjToContainerPoint(t.center);n[t.key]||(n[t.key]=1,o._drawCluster(e,t,1-r))}),0!==r&&e){var a=t.zoom,s=i._getResolution(a)*this.layer.options.maxClusterRadius,l=this._markerExtent.getMin();e.forEach(function(t){var e=i._prjToContainerPoint(t.center),n=t.center,u=Math.floor((n.x-l.x)/s)+"_"+Math.floor((n.y-l.y)/s),p=o._clusterCache[a].clusterMap[u];if(p){var h=i._prjToContainerPoint(p.center);e=h.add(e.sub(h)._multi(r))}o._drawCluster(e,t,r>.5?1:r)})}},r.prototype._drawClusters=function(t,e){var r=this;if(t){this._clusterMaskExtent=this.prepareCanvas();var o=this.getMap();t.forEach(function(t){var i=o._prjToContainerPoint(t.center);r._drawCluster(i,t,e>.5?1:e)})}},r.prototype._drawCluster=function(t,r,o){this._currentGrid=r;var i=this.context,n=this._getSprite(),a=i.globalAlpha;if(a*o!=0){if(i.globalAlpha=a*o,n){var s=t.add(n.offset)._sub(n.canvas.width/2,n.canvas.height/2);i.drawImage(n.canvas,s.x,s.y)}if(this.layer.options.drawClusterText&&r.textSize){e.Canvas.prepareCanvasFont(i,this._textSymbol);var l=this._textSymbol.textDx||0,u=this._textSymbol.textDy||0;e.Canvas.fillText(i,r.count,t.sub(r.textSize).add(l,u))}i.globalAlpha=a}},r.prototype._getSprite=function(){this._spriteCache||(this._spriteCache={});var t=e.Util.getSymbolStamp(this._symbol);return this._spriteCache[t]||(this._spriteCache[t]=new e.Marker([0,0],{symbol:this._symbol})._getSprite(this.resources,this.getMap().CanvasClass)),this._spriteCache[t]},r.prototype._initGridSystem=function(){var t=[],e=void 0,r=void 0;this.layer.forEach(function(o){r=o._getPrjCoordinates(),e=e?e._combine(o._getPrjExtent()):o._getPrjExtent(),t.push({x:r.x,y:r.y,id:o._getInternalId(),geometry:o})}),this._markerExtent=e,this._markerPoints=t},r.prototype._computeGrid=function(){var t=this.getMap(),e=t.getZoom();this._markerExtent||this._initGridSystem(),this._clusterCache||(this._clusterCache={});var r=t._getResolution(t.getMinZoom())>t._getResolution(t.getMaxZoom())?e-1:e+1;this._clusterCache[r]&&this._clusterCache[r].length===this.layer.getCount()&&(this._clusterCache[e]=this._clusterCache[r]),this._clusterCache[e]||(this._clusterCache[e]=this._computeZoomGrid(e))},r.prototype._computeZoomGrid=function(t){if(!this._markerExtent)return null;var r=this.getMap(),o=r._getResolution(t)*this.layer.options.maxClusterRadius,i=r._getResolution(t-1)?r._getResolution(t-1)*this.layer.options.maxClusterRadius:null,n=this._clusterCache[t-1];!n&&t-1>=r.getMinZoom()&&(this._clusterCache[t-1]=n=this._computeZoomGrid(t-1));for(var a=this._markerPoints,s={},l=this._markerExtent.getMin(),u=void 0,p=void 0,h=0,c=a.length;h<c;h++)s[u=Math.floor((a[h].x-l.x)/o)+"_"+Math.floor((a[h].y-l.y)/o)]?(s[u].sum._add(new e.Coordinate(a[h].x,a[h].y)),s[u].count++,s[u].center=s[u].sum.multi(1/s[u].count),s[u].children.push(a[h].geometry)):(s[u]={sum:new e.Coordinate(a[h].x,a[h].y),center:new e.Coordinate(a[h].x,a[h].y),count:1,children:[a[h].geometry],key:u+""},i&&n&&(p=Math.floor((a[h].x-l.x)/i)+"_"+Math.floor((a[h].y-l.y)/i),s[u].parent=n.clusterMap[p]));return this._mergeClusters(s,o/2)},r.prototype._mergeClusters=function(t,e){var r={};for(var o in t)r[o]=t[o];var i={},n={},a=void 0,s=void 0;for(var l in t)if(a=t[l],!n[a.key])for(var u=a.key.split("_"),p=+u[0],h=+u[1],c=-1;c<=1;c++)for(var y=-1;y<=1;y++)0===c&&0===y||(s=t[p+c+"_"+(h+y)])&&this._distanceTo(a.center,s.center)<=e&&(i[a.key]||(i[a.key]=[]),i[a.key].push(s),n[s.key]=1);for(var d in i){var _=t[d];if(_){for(var m=i[d],f=0;f<m.length;f++)t[m[f].key]&&(_.sum._add(m[f].sum),_.count+=m[f].count,_.children.concat(m[f].geometry),r[m[f].key]=_,delete t[m[f].key]);_.center=_.sum.multi(1/_.count)}}return{clusters:t,clusterMap:r}},r.prototype._distanceTo=function(t,e){var r=t.x-e.x,o=t.y-e.y;return Math.sqrt(r*r+o*o)},r.prototype._stopAnim=function(){this._player&&"finished"!==this._player.playState&&this._player.finish()},r.prototype.onZoomStart=function(e){this._stopAnim(),t.prototype.onZoomStart.call(this,e)},r.prototype.onZoomEnd=function(e){!this.layer.isEmpty()&&this.layer.isVisible()?(this._inout=e.from>e.to?"in":"out",this._animated=!0,this._computeGrid(),t.prototype.onZoomEnd.apply(this,arguments)):t.prototype.onZoomEnd.apply(this,arguments)},r.prototype._clearDataCache=function(){this._stopAnim(),delete this._markerExtent,delete this._markerPoints,delete this._clusterCache,delete this._zoomInClusters},r}(e.renderer.VectorLayerCanvasRenderer)),t.ClusterLayer=a,Object.defineProperty(t,"__esModule",{value:!0}),"undefined"!=typeof console&&console.log("maptalks.markercluster v0.7.0, requires maptalks@>=0.26.3.")});