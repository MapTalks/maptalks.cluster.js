/*!
 * maptalks.markercluster v2.0.2
 * LICENSE : MIT
 * (c) 2016-2017 maptalks.org
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("maptalks")):"function"==typeof define&&define.amd?define(["exports","maptalks"],t):t(e.maptalks=e.maptalks||{},e.maptalks)}(this,function(e,t){"use strict";function r(e,t){for(var r=Object.getOwnPropertyNames(t),o=0;o<r.length;o++){var n=r[o],a=Object.getOwnPropertyDescriptor(t,n);a&&a.configurable&&void 0===e[n]&&Object.defineProperty(e,n,a)}return e}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function n(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function a(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):r(e,t))}var i={maxClusterRadius:160,geometryEvents:!1,symbol:null,markerSymbol:null,drawClusterText:!0,textSymbol:null,animation:!0,animationDuration:450,maxClusterZoom:null},s=function(e){function r(){return o(this,r),n(this,e.apply(this,arguments))}return a(r,e),r.fromJSON=function(e){if(!e||"ClusterLayer"!==e.type)return null;for(var o=new r(e.id,e.options),n=e.geometries,a=[],i=0;i<n.length;i++){var s=t.Geometry.fromJSON(n[i]);s&&a.push(s)}return o.addGeometry(a),o},r.prototype.onConfig=function(t){return t.hasOwnProperty("symbol")&&this._getRenderer()&&this._getRenderer().onSymbolChanged(),e.prototype.onConfig.call(this,t)},r.prototype.addMarker=function(e){return this.addGeometry(e)},r.prototype.addGeometry=function(r){for(var o=0,n=r.length;o<=n;o++)if(!r[o]instanceof t.Marker)throw new Error("Only a point(Marker) can be added into a ClusterLayer");return e.prototype.addGeometry.apply(this,arguments)},r.prototype.identify=function(e,t){return this._getRenderer()?this._getRenderer().identify(e,t):null},r.prototype.toJSON=function(){var t=e.prototype.toJSON.call(this);return t.type="ClusterLayer",t},r}(t.VectorLayer);s.mergeOptions(i),s.registerJSONType("ClusterLayaer");var l={textFaceName:'"microsoft yahei"',textSize:16},h={markerType:"ellipse",markerFill:{property:"count",type:"interval",stops:[[0,"rgb(135, 196, 240)"],[9,"#1bbc9b"],[99,"rgb(216, 115, 149)"]]},markerFillOpacity:.7,markerLineOpacity:1,markerLineWidth:3,markerLineColor:"#fff",markerWidth:{property:"count",type:"interval",stops:[[0,40],[9,60],[99,80]]},markerHeight:{property:"count",type:"interval",stops:[[0,40],[9,60],[99,80]]}};s.registerRenderer("canvas",function(e){function r(a){o(this,r);var i=n(this,e.call(this,a)),s=t.INTERNAL_LAYER_PREFIX+"_cluster_"+t.Util.GUID();i._markerLayer=new t.VectorLayer(s).addTo(a.getMap());var l=t.INTERNAL_LAYER_PREFIX+"_cluster_all_"+t.Util.GUID();return i._allMarkerLayer=new t.VectorLayer(l,{visible:!1}).addTo(a.getMap()),i._animated=!0,i._refreshStyle(),i._clusterNeedRedraw=!0,i}return a(r,e),r.prototype.checkResources=function(){var r=e.prototype.checkResources.apply(this,arguments),o=t.Util.getExternalResources(this.layer.options.symbol||h,!0);return o&&r.push.apply(r,o),r},r.prototype.draw=function(){this.canvas||this.prepareCanvas();var e=this.getMap(),r=e.getZoom(),o=this.layer.options.markerSymbol,n=this.layer.options.maxClusterZoom;if(n&&r>n){if(this.prepareCanvas(),delete this._currentClusters,this._markerLayer.clear(),this._allMarkerLayer.getCount()!==this.layer.getCount()){this._allMarkerLayer.clear();var a=[];this.layer.forEach(function(e){a.push(e.copy().setSymbol(o||e.getSymbol()).copyEventListeners(e))}),this._allMarkerLayer.addGeometry(a)}return this._allMarkerLayer.show(),void this._completeAndFire()}this._allMarkerLayer.hide(),this._clusterNeedRedraw&&(this._clearDataCache(),this._computeGrid(),this._clusterNeedRedraw=!1);var i,s,l,h,c,p,u,y=this._clusterCache[r]?this._clusterCache[r].clusters:null,d=e.getContainerExtent(),_=[],m=[];for(var f in y)if(this._currentGrid=y[f],1!==y[f].count)h=this._getSprite(),c=h.canvas.width,p=h.canvas.height,s=e._prjToContainerPoint(y[f].center),l=new t.PointExtent(s.substract(c,p),s.add(c,p)),d.intersects(l)&&(u=t.StringUtil.getFont(this._textSymbol),y[f].textSize||(y[f].textSize=t.StringUtil.stringLength(y[f].count,u).toPoint()._multi(.5)),m.push(y[f]));else{var g=y[f].children[0];i=g.copy().setSymbol(o||g.getSymbol()).copyEventListeners(y[f].children[0]),i._cluster=y[f],_.push(i)}this._drawLayer(m,_)},r.prototype.drawOnZooming=function(){this._currentClusters&&this._drawClusters(this._currentClusters,1)},r.prototype.onGeometryAdd=function(){this._clusterNeedRedraw=!0,this.render()},r.prototype.onGeometryRemove=function(){this._clusterNeedRedraw=!0,this.render()},r.prototype.onGeometryPositionChange=function(){this._markerLayer.clear(),this._allMarkerLayer.clear(),this._clusterNeedRedraw=!0,this.render()},r.prototype.onGeometrySymbolChange=function(){this._markerLayer.clear(),this._allMarkerLayer.clear(),this.render(!0)},r.prototype.onRemove=function(){this._clearDataCache(),this._markerLayer.remove(),this._allMarkerLayer.remove()},r.prototype.show=function(){this._markerLayer.show(),this._allMarkerLayer.show(),t.renderer.CanvasRenderer.prototype.show.call(this)},r.prototype.hide=function(){this._markerLayer.hide(),this._allMarkerLayer.hide(),t.renderer.CanvasRenderer.prototype.hide.call(this)},r.prototype.setZIndex=function(e){this._markerLayer.setZIndex(e),this._allMarkerLayer.setZIndex(e),t.renderer.CanvasRenderer.prototype.setZIndex.call(this,e)},r.prototype.transform=function(e){return this._currentClusters&&this._drawClusters(this._currentClusters,1,e),!0},r.prototype.identify=function(e){var t=this.getMap();if(e=t._pointToContainerPoint(e),!this._currentClusters)return null;for(var r=this._currentGrid,o=0;o<this._currentClusters.length;o++){var n=this._currentClusters[o],a=t._prjToContainerPoint(n.center);this._currentGrid=n;var i=this._getSprite().canvas.width;if(e.distanceTo(a)<=i)return{center:t.getProjection().unproject(n.center.copy()),children:n.children.slice(0)}}return this._currentGrid=r,null},r.prototype.onSymbolChanged=function(){this._refreshStyle(),this._computeGrid(),this._stopAnim(),this.draw()},r.prototype.isUpdateWhenZooming=function(){return!0},r.prototype._refreshStyle=function(){var e=this,r=this.layer.options.symbol||h,o=this.layer.options.textSymbol||l,n=function(){return[e.getMap().getZoom(),e._currentGrid]};this._symbol=t.MapboxUtil.loadFunctionTypes(r,n),this._textSymbol=t.MapboxUtil.loadFunctionTypes(o,n)},r.prototype._drawLayer=function(e,r,o){var n=this;this._currentClusters=e;var a=this.layer;a.options.animation&&this._animated&&"out"===this._inout?(this._player=t.animation.Animation.animate({d:[0,1]},{speed:a.options.animationDuration,easing:"inAndOut"},function(t){"finished"===t.state.playState?(n._markerLayer.getCount()>0&&n._markerLayer.clear(),n._markerLayer.addGeometry(r),n._animated=!1,n._completeAndFire()):(n._drawClusters(e,t.styles.d,o),n.requestMapToRender())}).play(),this._drawClusters(e,0,o),this.requestMapToRender()):(this._drawClusters(e,1,o),o||!this._animated&&0!==this._markerLayer.getCount()||(this._markerLayer.getCount()>0&&this._markerLayer.clear(),this._markerLayer.addGeometry(r)),this._animated=!1,this._completeAndFire())},r.prototype._drawClusters=function(e,t,r){var o=this;r=r?r.container:null,this.prepareCanvas();var n=this.getMap(),a={};e.forEach(function(e){if(e.parent){var i=n._prjToContainerPoint(e.parent.center);a[e.parent.key]||(r&&(i=r.applyToPointInstance(i)),a[e.parent.key]=1,o._drawCluster(i,e.parent,1-t))}}),0!==t&&e.forEach(function(e){var a=n._prjToContainerPoint(e.center);if(e.parent){var i=n._prjToContainerPoint(e.parent.center);a=i.add(a.substract(i)._multi(t))}r&&(a=r.applyToPointInstance(a)),o._drawCluster(a,e,t>.5?1:t)})},r.prototype._drawCluster=function(e,r,o){this._currentGrid=r;var n=this.context,a=this._getSprite(),i=n.globalAlpha;if(i*o!=0){if(n.globalAlpha=i*o,a){var s=e.add(a.offset)._substract(a.canvas.width/2,a.canvas.height/2);n.drawImage(a.canvas,s.x,s.y)}this.layer.options.drawClusterText&&r.textSize&&(t.Canvas.prepareCanvasFont(n,this._textSymbol),t.Canvas.fillText(n,r.count,e.substract(r.textSize))),n.globalAlpha=i}},r.prototype._completeAndFire=function(){var e=this,t=this.getMap().getZoom(),r=this.layer.options.maxClusterZoom;r&&t>r?this._allMarkerLayer&&this._allMarkerLayer.getCount()>0&&!this._allMarkerLayer.isLoaded()?this._allMarkerLayer.once("layerload",function(){e.completeRender()}):this.completeRender():this._markerLayer&&this._markerLayer.getCount()>0&&!this._markerLayer.isLoaded()?this._markerLayer.once("layerload",function(){e.completeRender()}):this.completeRender()},r.prototype._getSprite=function(){this._spriteCache||(this._spriteCache={});var e=t.Util.getSymbolStamp(this._symbol);return this._spriteCache[e]||(this._spriteCache[e]=new t.Marker([0,0],{symbol:this._symbol})._getSprite(this.resources)),this._spriteCache[e]},r.prototype._initGridSystem=function(){var e,t,r=[];this.layer.forEach(function(o){t=o._getPrjCoordinates(),e=e?e._combine(o._getPrjExtent()):o._getPrjExtent(),r.push({x:t.x,y:t.y,id:o._getInternalId(),geometry:o})}),this._markerExtent=e,this._markerPoints=r},r.prototype._computeGrid=function(){var e=this.getMap(),t=e.getZoom();this._markerExtent||this._initGridSystem(),this._clusterCache||(this._clusterCache={});var r=e._getResolution(e.getMinZoom())>e._getResolution(e.getMaxZoom())?t-1:t+1;this._clusterCache[r]&&this._clusterCache[r].length===this.layer.getCount()&&(this._clusterCache[t]=this._clusterCache[r]),this._clusterCache[t]||(this._clusterCache[t]=this._computeZoomGrid(t))},r.prototype._computeZoomGrid=function(e){if(!this._markerExtent)return null;var r=this.getMap(),o=r._getResolution(e)*this.layer.options.maxClusterRadius,n=this._clusterCache[e-1],a=r._getResolution(e-1)?r._getResolution(e-1)*this.layer.options.maxClusterRadius:null;!n&&e-1>=r.getMinZoom()&&(this._clusterCache[e-1]=n=this._computeZoomGrid(e-1));for(var i,s,l,h,c,p,u=this._markerPoints,y={},d=this._markerExtent.getMin(),_=0,m=u.length;_<m;_++)i=Math.floor((u[_].x-d.x)/o),s=Math.floor((u[_].y-d.y)/o),l=i+"_"+s,y[l]?(y[l].sum._add(new t.Coordinate(u[_].x,u[_].y)),y[l].count++,y[l].center=y[l].sum.multi(1/y[l].count),y[l].children.push(u[_].geometry)):(y[l]={sum:new t.Coordinate(u[_].x,u[_].y),center:new t.Coordinate(u[_].x,u[_].y),count:1,children:[u[_].geometry],key:l+""},a&&n&&(h=Math.floor((u[_].x-d.x)/a),c=Math.floor((u[_].y-d.y)/a),p=h+"_"+c,y[l].parent=n.clusterMap[p]));return this._mergeClusters(y,o/2)},r.prototype._mergeClusters=function(e,t){var r,o={};for(r in e)o[r]=e[r];var n,a,i={},s={};for(r in e)if(n=e[r],!s[n.key])for(var l=n.key.split("_"),h=+l[0],c=+l[1],p=-1;p<=1;p++)for(var u=-1;u<=1;u++)if(0!==p||0!==u){var y=h+p+"_"+(c+u);a=e[y],a&&this._distanceTo(n.center,a.center)<=t&&(i[n.key]||(i[n.key]=[]),i[n.key].push(a),s[a.key]=1)}for(var d in i){var _=e[d];if(_){for(var m=i[d],f=0;f<m.length;f++)e[m[f].key]&&(_.sum._add(m[f].sum),_.count+=m[f].count,_.children.concat(m[f].geometry),o[m[f].key]=_,delete e[m[f].key]);_.center=_.sum.multi(1/_.count)}}return{clusters:e,clusterMap:o}},r.prototype._distanceTo=function(e,t){var r=e.x-t.x,o=e.y-t.y;return Math.sqrt(r*r+o*o)},r.prototype._stopAnim=function(){this._player&&"finished"!==this._player.playState&&this._player.cancel()},r.prototype.onZoomStart=function(e){this._inout=e.from>e.to?"in":"out";var t=this.layer.options.maxClusterZoom;t&&e.to<=t&&this._allMarkerLayer.hide(),this._stopAnim()},r.prototype.onZoomEnd=function(){this._animated=!0,this._computeGrid(),t.renderer.CanvasRenderer.prototype.onZoomEnd.apply(this,arguments)},r.prototype._clearDataCache=function(){this._stopAnim(),this._markerLayer.clear(),delete this._markerExtent,delete this._markerPoints,delete this._clusterCache},r}(t.renderer.OverlayLayerCanvasRenderer)),e.ClusterLayer=s,Object.defineProperty(e,"__esModule",{value:!0})});