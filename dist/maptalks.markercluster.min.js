/*!
 * maptalks.markercluster v2.0.2
 * LICENSE : MIT
 * (c) 2016-2017 maptalks.org
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("maptalks")):"function"==typeof define&&define.amd?define(["exports","maptalks"],e):e(t.maptalks=t.maptalks||{},t.maptalks)}(this,function(t,e){"use strict";function r(t,e){for(var r=Object.getOwnPropertyNames(e),o=0;o<r.length;o++){var i=r[o],n=Object.getOwnPropertyDescriptor(e,i);n&&n.configurable&&void 0===t[i]&&Object.defineProperty(t,i,n)}return t}function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function n(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):r(t,e))}var a={maxClusterRadius:160,geometryEvents:!1,symbol:null,markerSymbol:null,drawClusterText:!0,textSymbol:null,animation:!0,animationDuration:450,maxClusterZoom:null},s=function(t){function r(){return o(this,r),i(this,t.apply(this,arguments))}return n(r,t),r.fromJSON=function(t){if(!t||"ClusterLayer"!==t.type)return null;for(var o=new r(t.id,t.options),i=t.geometries,n=[],a=0;a<i.length;a++){var s=e.Geometry.fromJSON(i[a]);s&&n.push(s)}return o.addGeometry(n),o},r.prototype.onConfig=function(e){return e.hasOwnProperty("symbol")&&this._getRenderer()&&this._getRenderer().onSymbolChanged(),t.prototype.onConfig.call(this,e)},r.prototype.addMarker=function(t){return this.addGeometry(t)},r.prototype.addGeometry=function(r){for(var o=0,i=r.length;o<=i;o++)if(!r[o]instanceof e.Marker)throw new Error("Only a point(Marker) can be added into a ClusterLayer");return t.prototype.addGeometry.apply(this,arguments)},r.prototype.identify=function(t,e){return this._getRenderer()?this._getRenderer().identify(t,e):null},r.prototype.toJSON=function(){var e=t.prototype.toJSON.call(this);return e.type="ClusterLayer",e},r.prototype.getClusters=function(){return this._currentClusters?this._currentClusters:null},r}(e.VectorLayer);s.mergeOptions(a),s.registerJSONType("ClusterLayaer");var l={textFaceName:'"microsoft yahei"',textSize:16},h={markerType:"ellipse",markerFill:{property:"count",type:"interval",stops:[[0,"rgb(135, 196, 240)"],[9,"#1bbc9b"],[99,"rgb(216, 115, 149)"]]},markerFillOpacity:.7,markerLineOpacity:1,markerLineWidth:3,markerLineColor:"#fff",markerWidth:{property:"count",type:"interval",stops:[[0,40],[9,60],[99,80]]},markerHeight:{property:"count",type:"interval",stops:[[0,40],[9,60],[99,80]]}};s.registerRenderer("canvas",function(t){function r(n){o(this,r);var a=i(this,t.call(this,n)),s=e.INTERNAL_LAYER_PREFIX+"_cluster_"+e.Util.GUID();a._markerLayer=new e.VectorLayer(s).addTo(n.getMap());var l=e.INTERNAL_LAYER_PREFIX+"_cluster_all_"+e.Util.GUID();return a._allMarkerLayer=new e.VectorLayer(l,{visible:!1}).addTo(n.getMap()),a._animated=!0,a._refreshStyle(),a._clusterNeedRedraw=!0,a}return n(r,t),r.prototype.checkResources=function(){var r=t.prototype.checkResources.apply(this,arguments),o=e.Util.getExternalResources(this.layer.options.symbol||h,!0);return o&&r.push.apply(r,o),r},r.prototype.draw=function(){this.canvas||this.prepareCanvas();var t=this.getMap(),r=t.getZoom(),o=this.layer.options.markerSymbol,i=this.layer.options.maxClusterZoom;if(i&&r>i){if(this.prepareCanvas(),delete this._currentClusters,this._markerLayer.clear(),this._allMarkerLayer.getCount()!==this.layer.getCount()){this._allMarkerLayer.clear();var n=[];this.layer.forEach(function(t){n.push(t.copy().setSymbol(o||t.getSymbol()).copyEventListeners(t))}),this._allMarkerLayer.addGeometry(n)}return this._allMarkerLayer.show(),void this._completeAndFire()}this._allMarkerLayer.hide(),this._clusterNeedRedraw&&(this._clearDataCache(),this._computeGrid(),this._clusterNeedRedraw=!1);var a,s,l,h,u,c,p,y=this._clusterCache[r]?this._clusterCache[r].clusters:null,_=t.getContainerExtent(),d=[],m=[];for(var f in y)if(this._currentGrid=y[f],1!==y[f].count)h=this._getSprite(),u=h.canvas.width,c=h.canvas.height,s=t._prjToContainerPoint(y[f].center),l=new e.PointExtent(s.substract(u,c),s.add(u,c)),_.intersects(l)&&(p=e.StringUtil.getFont(this._textSymbol),y[f].textSize||(y[f].textSize=e.StringUtil.stringLength(y[f].count,p).toPoint()._multi(.5)),m.push(y[f]));else{var C=y[f].children[0];a=C.copy().setSymbol(o||C.getSymbol()).copyEventListeners(y[f].children[0]),a._cluster=y[f],d.push(a)}this._drawLayer(m,d)},r.prototype.drawOnZooming=function(){this._currentClusters&&this._drawClusters(this._currentClusters,1)},r.prototype.onGeometryAdd=function(){this._clusterNeedRedraw=!0,this.render()},r.prototype.onGeometryRemove=function(){this._clusterNeedRedraw=!0,this.render()},r.prototype.onGeometryPositionChange=function(){this._markerLayer.clear(),this._allMarkerLayer.clear(),this._clusterNeedRedraw=!0,this.render()},r.prototype.onGeometrySymbolChange=function(){this._markerLayer.clear(),this._allMarkerLayer.clear(),this.render(!0)},r.prototype.onRemove=function(){this._clearDataCache(),this._markerLayer.remove(),this._allMarkerLayer.remove()},r.prototype.show=function(){this._markerLayer.show(),this._allMarkerLayer.show(),e.renderer.CanvasRenderer.prototype.show.call(this)},r.prototype.hide=function(){this._markerLayer.hide(),this._allMarkerLayer.hide(),e.renderer.CanvasRenderer.prototype.hide.call(this)},r.prototype.setZIndex=function(t){this._markerLayer.setZIndex(t),this._allMarkerLayer.setZIndex(t),e.renderer.CanvasRenderer.prototype.setZIndex.call(this,t)},r.prototype.transform=function(t){return this._currentClusters&&this._drawClusters(this._currentClusters,1,t),!0},r.prototype.identify=function(t){var e=this.getMap();if(t=e._pointToContainerPoint(t),!this._currentClusters)return null;for(var r=this._currentGrid,o=0;o<this._currentClusters.length;o++){var i=this._currentClusters[o],n=e._prjToContainerPoint(i.center);this._currentGrid=i;var a=this._getSprite().canvas.width;if(t.distanceTo(n)<=a)return{center:e.getProjection().unproject(i.center.copy()),children:i.children.slice(0)}}return this._currentGrid=r,null},r.prototype.onSymbolChanged=function(){this._refreshStyle(),this._computeGrid(),this._stopAnim(),this.draw()},r.prototype.isUpdateWhenZooming=function(){return!0},r.prototype._refreshStyle=function(){var t=this,r=this.layer.options.symbol||h,o=this.layer.options.textSymbol||l,i=function(){return[t.getMap().getZoom(),t._currentGrid]};this._symbol=e.MapboxUtil.loadFunctionTypes(r,i),this._textSymbol=e.MapboxUtil.loadFunctionTypes(o,i)},r.prototype._drawLayer=function(t,r,o){var i=this;this._currentClusters=this.layer._currentClusters=t;var n=this.layer,a=[0,1];n.options.animation&&this._animated&&this._inout?("in"===this._inout?(a=[1,0],t=this._zoomInClusters):"out"===this._inout&&(a=[0,1]),this._player=e.animation.Animation.animate({d:a},{speed:n.options.animationDuration,easing:"inAndOut"},function(e){"finished"===e.state.playState?(i._markerLayer.getCount()>0&&i._markerLayer.clear(),i._markerLayer.addGeometry(r),i._animated=!1,i._completeAndFire()):(i._drawClusters(t,e.styles.d,o),i.requestMapToRender())}).play(),this._drawClusters(t,a[0],o),this.requestMapToRender()):(this._drawClusters(t,1,o),o||!this._animated&&0!==this._markerLayer.getCount()||(this._markerLayer.getCount()>0&&this._markerLayer.clear(),this._markerLayer.addGeometry(r)),this._animated=!1,this._completeAndFire())},r.prototype._drawClusters=function(t,e,r){var o=this;r=r?r.container:null,this.prepareCanvas();var i=this.getMap(),n={};t.forEach(function(t){if(t.parent){var a=i._prjToContainerPoint(t.parent.center);n[t.parent.key]||(r&&(a=r.applyToPointInstance(a)),n[t.parent.key]=1,o._drawCluster(a,t.parent,1-e))}}),0!==e&&t.forEach(function(t){var n=i._prjToContainerPoint(t.center);if(t.parent){var a=i._prjToContainerPoint(t.parent.center);n=a.add(n.substract(a)._multi(e))}r&&(n=r.applyToPointInstance(n)),o._drawCluster(n,t,e>.5?1:e)})},r.prototype._drawCluster=function(t,r,o){this._currentGrid=r;var i=this.context,n=this._getSprite(),a=i.globalAlpha;if(a*o!=0){if(i.globalAlpha=a*o,n){var s=t.add(n.offset)._substract(n.canvas.width/2,n.canvas.height/2);i.drawImage(n.canvas,s.x,s.y)}this.layer.options.drawClusterText&&r.textSize&&(e.Canvas.prepareCanvasFont(i,this._textSymbol),e.Canvas.fillText(i,r.count,t.substract(r.textSize))),i.globalAlpha=a}},r.prototype._completeAndFire=function(){var t=this,e=this.getMap().getZoom(),r=this.layer.options.maxClusterZoom;r&&e>r?this._allMarkerLayer&&this._allMarkerLayer.getCount()>0&&!this._allMarkerLayer.isLoaded()?this._allMarkerLayer.once("layerload",function(){t.completeRender()}):this.completeRender():this._markerLayer&&this._markerLayer.getCount()>0&&!this._markerLayer.isLoaded()?this._markerLayer.once("layerload",function(){t.completeRender()}):this.completeRender()},r.prototype._getSprite=function(){this._spriteCache||(this._spriteCache={});var t=e.Util.getSymbolStamp(this._symbol);return this._spriteCache[t]||(this._spriteCache[t]=new e.Marker([0,0],{symbol:this._symbol})._getSprite(this.resources)),this._spriteCache[t]},r.prototype._initGridSystem=function(){var t,e,r=[];this.layer.forEach(function(o){e=o._getPrjCoordinates(),t=t?t._combine(o._getPrjExtent()):o._getPrjExtent(),r.push({x:e.x,y:e.y,id:o._getInternalId(),geometry:o})}),this._markerExtent=t,this._markerPoints=r},r.prototype._computeGrid=function(){var t=this.getMap(),e=t.getZoom();this._markerExtent||this._initGridSystem(),this._clusterCache||(this._clusterCache={});var r=t._getResolution(t.getMinZoom())>t._getResolution(t.getMaxZoom())?e-1:e+1;this._clusterCache[r]&&this._clusterCache[r].length===this.layer.getCount()&&(this._clusterCache[e]=this._clusterCache[r]),this._clusterCache[e]||(this._clusterCache[e]=this._computeZoomGrid(e))},r.prototype._computeZoomGrid=function(t){if(!this._markerExtent)return null;var r=this.getMap(),o=r._getResolution(t)*this.layer.options.maxClusterRadius,i=this._clusterCache[t-1],n=r._getResolution(t-1)?r._getResolution(t-1)*this.layer.options.maxClusterRadius:null;!i&&t-1>=r.getMinZoom()&&(this._clusterCache[t-1]=i=this._computeZoomGrid(t-1));for(var a,s,l,h,u,c,p=this._markerPoints,y={},_=this._markerExtent.getMin(),d=0,m=p.length;d<m;d++)a=Math.floor((p[d].x-_.x)/o),s=Math.floor((p[d].y-_.y)/o),l=a+"_"+s,y[l]?(y[l].sum._add(new e.Coordinate(p[d].x,p[d].y)),y[l].count++,y[l].center=y[l].sum.multi(1/y[l].count),y[l].children.push(p[d].geometry)):(y[l]={sum:new e.Coordinate(p[d].x,p[d].y),center:new e.Coordinate(p[d].x,p[d].y),count:1,children:[p[d].geometry],key:l+""},n&&i&&(h=Math.floor((p[d].x-_.x)/n),u=Math.floor((p[d].y-_.y)/n),c=h+"_"+u,y[l].parent=i.clusterMap[c]));return this._mergeClusters(y,o/2)},r.prototype._mergeClusters=function(t,e){var r,o={};for(r in t)o[r]=t[r];var i,n,a={},s={};for(r in t)if(i=t[r],!s[i.key])for(var l=i.key.split("_"),h=+l[0],u=+l[1],c=-1;c<=1;c++)for(var p=-1;p<=1;p++)if(0!==c||0!==p){var y=h+c+"_"+(u+p);n=t[y],n&&this._distanceTo(i.center,n.center)<=e&&(a[i.key]||(a[i.key]=[]),a[i.key].push(n),s[n.key]=1)}for(var _ in a){var d=t[_];if(d){for(var m=a[_],f=0;f<m.length;f++)t[m[f].key]&&(d.sum._add(m[f].sum),d.count+=m[f].count,d.children.concat(m[f].geometry),o[m[f].key]=d,delete t[m[f].key]);d.center=d.sum.multi(1/d.count)}}return{clusters:t,clusterMap:o}},r.prototype._distanceTo=function(t,e){var r=t.x-e.x,o=t.y-e.y;return Math.sqrt(r*r+o*o)},r.prototype._stopAnim=function(){this._player&&"finished"!==this._player.playState&&this._player.cancel()},r.prototype.onZoomStart=function(t){this._inout=t.from>t.to?"in":"out";var e=this.layer.options.maxClusterZoom;e&&t.to<=e&&this._allMarkerLayer.hide(),this._stopAnim()},r.prototype.onZoomEnd=function(){this._animated=!0;var t=this.getMap().getZoom();if(this._computeGrid(),"in"===this._inout){this._clusterCache[t+1]||(this._clusterCache[t+1]=this._computeZoomGrid(t+1));var r=this._clusterCache[t+1].clusters;this._zoomInClusters=[];for(var o in r)this._zoomInClusters.push(r[o])}e.renderer.CanvasRenderer.prototype.onZoomEnd.apply(this,arguments)},r.prototype._clearDataCache=function(){this._stopAnim(),this._markerLayer.clear(),delete this._markerExtent,delete this._markerPoints,delete this._clusterCache},r}(e.renderer.OverlayLayerCanvasRenderer)),t.ClusterLayer=s,Object.defineProperty(t,"__esModule",{value:!0})});